(function(){var d;d=typeof exports!=="undefined"?exports:this.Backbone={};d.VERSION="0.3.3";var e=this._;if(!e&&typeof require!=="undefined")e=require("underscore")._;var g=this.jQuery||this.Zepto;d.emulateHTTP=!1;d.emulateJSON=!1;d.Events={bind:function(a,b){this._callbacks||(this._callbacks={});(this._callbacks[a]||(this._callbacks[a]=[])).push(b);return this},unbind:function(a,b){var c;if(a){if(c=this._callbacks)if(b){c=c[a];if(!c)return this;for(var f=0,d=c.length;f<d;f++)if(b===c[f]){c.splice(f,
1);break}}else c[a]=[]}else this._callbacks={};return this},trigger:function(a){var b,c,f,d;if(!(c=this._callbacks))return this;if(b=c[a]){f=0;for(d=b.length;f<d;f++)b[f].apply(this,Array.prototype.slice.call(arguments,1))}if(b=c.all){f=0;for(d=b.length;f<d;f++)b[f].apply(this,arguments)}return this}};d.Model=function(a,b){a||(a={});this.defaults&&(a=e.extend({},this.defaults,a));this.attributes={};this._escapedAttributes={};this.cid=e.uniqueId("c");this.set(a,{silent:!0});this._previousAttributes=
e.clone(this.attributes);if(b&&b.collection)this.collection=b.collection;this.initialize(a,b)};e.extend(d.Model.prototype,d.Events,{_previousAttributes:null,_changed:!1,initialize:function(){},toJSON:function(){return e.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;if(b=this._escapedAttributes[a])return b;b=this.attributes[a];return this._escapedAttributes[a]=(b==null?"":b).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,
"&quot;")},set:function(a,b){b||(b={});if(!a)return this;if(a.attributes)a=a.attributes;var c=this.attributes,f=this._escapedAttributes;if(!b.silent&&this.validate&&!this._performValidation(a,b))return!1;if("id"in a)this.id=a.id;for(var d in a){var g=a[d];if(!e.isEqual(c[d],g)&&(c[d]=g,delete f[d],!b.silent))this._changed=!0,this.trigger("change:"+d,this,g,b)}!b.silent&&this._changed&&this.change(b);return this},unset:function(a,b){b||(b={});var c={};c[a]=void 0;if(!b.silent&&this.validate&&!this._performValidation(c,
b))return!1;delete this.attributes[a];delete this._escapedAttributes[a];if(!b.silent)this._changed=!0,this.trigger("change:"+a,this,void 0,b),this.change(b);return this},clear:function(a){a||(a={});var b=this.attributes,c={};for(attr in b)c[attr]=void 0;if(!a.silent&&this.validate&&!this._performValidation(c,a))return!1;this.attributes={};this._escapedAttributes={};if(!a.silent){this._changed=!0;for(attr in b)this.trigger("change:"+attr,this,void 0,a);this.change(a)}return this},fetch:function(a){a||
(a={});var b=this,c=h(a.error,b,a);(this.sync||d.sync)("read",this,function(c){if(!b.set(b.parse(c),a))return!1;a.success&&a.success(b,c)},c);return this},save:function(a,b){b||(b={});if(a&&!this.set(a,b))return!1;var c=this,f=h(b.error,c,b),e=this.isNew()?"create":"update";(this.sync||d.sync)(e,this,function(a){if(!c.set(c.parse(a),b))return!1;b.success&&b.success(c,a)},f);return this},destroy:function(a){a||(a={});var b=this,c=h(a.error,b,a);(this.sync||d.sync)("delete",this,function(c){b.collection&&
b.collection.remove(b);a.success&&a.success(b,c)},c);return this},url:function(){var a=j(this.collection);return this.isNew()?a:a+(a.charAt(a.length-1)=="/"?"":"/")+this.id},parse:function(a){return a},clone:function(){return new this.constructor(this)},isNew:function(){return!this.id},change:function(a){this.trigger("change",this,a);this._previousAttributes=e.clone(this.attributes);this._changed=!1},hasChanged:function(a){return a?this._previousAttributes[a]!=this.attributes[a]:this._changed},changedAttributes:function(a){a||
(a=this.attributes);var b=this._previousAttributes,c=!1,f;for(f in a)e.isEqual(b[f],a[f])||(c=c||{},c[f]=a[f]);return c},previous:function(a){return!a||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return e.clone(this._previousAttributes)},_performValidation:function(a,b){var c=this.validate(a);return c?(b.error?b.error(this,c):this.trigger("error",this,c,b),!1):!0}});d.Collection=function(a,b){b||(b={});if(b.comparator)this.comparator=b.comparator,delete b.comparator;
this._boundOnModelEvent=e.bind(this._onModelEvent,this);this._reset();a&&this.refresh(a,{silent:!0});this.initialize(a,b)};e.extend(d.Collection.prototype,d.Events,{model:d.Model,initialize:function(){},toJSON:function(){return this.map(function(a){return a.toJSON()})},add:function(a,b){if(e.isArray(a))for(var c=0,f=a.length;c<f;c++)this._add(a[c],b);else this._add(a,b);return this},remove:function(a,b){if(e.isArray(a))for(var c=0,f=a.length;c<f;c++)this._remove(a[c],b);else this._remove(a,b);return this},
get:function(a){return a==null?null:this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},sort:function(a){a||(a={});if(!this.comparator)throw Error("Cannot sort a set without a comparator");this.models=this.sortBy(this.comparator);a.silent||this.trigger("refresh",this,a);return this},pluck:function(a){return e.map(this.models,function(b){return b.get(a)})},refresh:function(a,b){a||(a=[]);b||(b={});this._reset();this.add(a,{silent:!0});
b.silent||this.trigger("refresh",this,b);return this},fetch:function(a){a||(a={});var b=this,c=h(a.error,b,a);(this.sync||d.sync)("read",this,function(c){b.refresh(b.parse(c));a.success&&a.success(b,c)},c);return this},create:function(a,b){var c=this;b||(b={});a instanceof d.Model?a.collection=c:a=new this.model(a,{collection:c});return a.save(null,{success:function(a,d){c.add(a);b.success&&b.success(a,d)},error:b.error})},parse:function(a){return a},chain:function(){return e(this.models).chain()},
_reset:function(){this.length=0;this.models=[];this._byId={};this._byCid={}},_add:function(a,b){b||(b={});a instanceof d.Model||(a=new this.model(a,{collection:this}));var c=this.getByCid(a);if(c)throw Error(["Can't add the same model to a set twice",c.id]);this._byId[a.id]=a;this._byCid[a.cid]=a;a.collection=this;this.models.splice(this.comparator?this.sortedIndex(a,this.comparator):this.length,0,a);a.bind("all",this._boundOnModelEvent);this.length++;b.silent||a.trigger("add",a,this,b);return a},
_remove:function(a,b){b||(b={});a=this.getByCid(a)||this.get(a);if(!a)return null;delete this._byId[a.id];delete this._byCid[a.cid];delete a.collection;this.models.splice(this.indexOf(a),1);this.length--;b.silent||a.trigger("remove",a,this,b);a.unbind("all",this._boundOnModelEvent);return a},_onModelEvent:function(a,b){a==="change:id"&&(delete this._byId[b.previous("id")],this._byId[b.id]=b);this.trigger.apply(this,arguments)}});e.each("forEach,each,map,reduce,reduceRight,find,detect,filter,select,reject,every,all,some,any,include,invoke,max,min,sortBy,sortedIndex,toArray,size,first,rest,last,without,indexOf,lastIndexOf,isEmpty".split(","),
function(a){d.Collection.prototype[a]=function(){return e[a].apply(e,[this.models].concat(e.toArray(arguments)))}});d.Controller=function(a){a||(a={});if(a.routes)this.routes=a.routes;this._bindRoutes();this.initialize(a)};var n=/:([\w\d]+)/g,o=/\*([\w\d]+)/g;e.extend(d.Controller.prototype,d.Events,{initialize:function(){},route:function(a,b,c){d.history||(d.history=new d.History);e.isRegExp(a)||(a=this._routeToRegExp(a));d.history.route(a,e.bind(function(d){d=this._extractParameters(a,d);c.apply(this,
d);this.trigger.apply(this,["route:"+b].concat(d))},this))},saveLocation:function(a){d.history.saveLocation(a)},_bindRoutes:function(){if(this.routes)for(var a in this.routes){var b=this.routes[a];this.route(a,b,this[b])}},_routeToRegExp:function(a){a=a.replace(n,"([^/]*)").replace(o,"(.*?)");return RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}});d.History=function(){this.handlers=[];this.fragment=this.getFragment();e.bindAll(this,"checkUrl")};var k=/^#*/;e.extend(d.History.prototype,
{interval:50,getFragment:function(a){return(a||window.location).hash.replace(k,"")},start:function(){var a=document.documentMode;if(a=g.browser.msie&&(!a||a<=7))this.iframe=g('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;"onhashchange"in window&&!a?g(window).bind("hashchange",this.checkUrl):setInterval(this.checkUrl,this.interval);return this.loadUrl()},route:function(a,b){this.handlers.push({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();
a==this.fragment&&this.iframe&&(a=this.getFragment(this.iframe.location));if(a==this.fragment||a==decodeURIComponent(this.fragment))return!1;if(this.iframe)window.location.hash=this.iframe.location.hash=a;this.loadUrl()},loadUrl:function(){var a=this.fragment=this.getFragment();return e.any(this.handlers,function(b){if(b.route.test(a))return b.callback(a),!0})},saveLocation:function(a){a=(a||"").replace(k,"");if(this.fragment!=a&&(window.location.hash=this.fragment=a,this.iframe&&a!=this.getFragment(this.iframe.location)))this.iframe.document.open().close(),
this.iframe.location.hash=a}});d.View=function(a){this._configure(a||{});this._ensureElement();this.delegateEvents();this.initialize(a)};var p=/^(\w+)\s*(.*)$/;e.extend(d.View.prototype,d.Events,{tagName:"div",$:function(a){return g(a,this.el)},initialize:function(){},render:function(){return this},remove:function(){g(this.el).remove();return this},make:function(a,b,c){a=document.createElement(a);b&&g(a).attr(b);c&&g(a).html(c);return a},delegateEvents:function(a){if(a||(a=this.events)){g(this.el).unbind();
for(var b in a){var c=a[b],d=b.match(p),i=d[1],d=d[2],c=e.bind(this[c],this);d===""?g(this.el).bind(i,c):g(this.el).delegate(d,i,c)}}},_configure:function(a){this.options&&(a=e.extend({},this.options,a));if(a.model)this.model=a.model;if(a.collection)this.collection=a.collection;if(a.el)this.el=a.el;if(a.id)this.id=a.id;if(a.className)this.className=a.className;if(a.tagName)this.tagName=a.tagName;this.options=a},_ensureElement:function(){if(!this.el){var a={};if(this.id)a.id=this.id;if(this.className)a["class"]=
this.className;this.el=this.make(this.tagName,a)}}});var l=function(a,b){var c=q(this,a,b);c.extend=l;return c};d.Model.extend=d.Collection.extend=d.Controller.extend=d.View.extend=l;var r={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};d.sync=function(a,b,c,f){var e=r[a],a=a==="create"||a==="update"?JSON.stringify(b.toJSON()):null,b={url:j(b),type:e,contentType:"application/json",data:a,dataType:"json",processData:!1,success:c,error:f};if(d.emulateJSON)b.contentType="application/x-www-form-urlencoded",
b.processData=!0,b.data=a?{model:a}:{};if(d.emulateHTTP&&(e==="PUT"||e==="DELETE")){if(d.emulateJSON)b.data._method=e;b.type="POST";b.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",e)}}g.ajax(b)};var m=function(){},q=function(a,b,c){var d;d=b&&b.hasOwnProperty("constructor")?b.constructor:function(){return a.apply(this,arguments)};m.prototype=a.prototype;d.prototype=new m;b&&e.extend(d.prototype,b);c&&e.extend(d,c);d.prototype.constructor=d;d.__super__=a.prototype;return d},j=
function(a){if(!a||!a.url)throw Error("A 'url' property or function must be specified");return e.isFunction(a.url)?a.url():a.url},h=function(a,b,c){return function(d){a?a(b,d):b.trigger("error",b,d,c)}}})();
